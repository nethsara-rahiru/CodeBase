<!--login-access.html-->>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Access Control</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #0f172a, #1e3a8a);
        color: white;
    }

    .nav {
        padding: 15px 25px;
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(8px);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .container {
        padding: 25px;
        max-width: 1100px;
        margin: auto;
    }

    h2 {
        margin-bottom: 10px;
        margin-top: 35px;
    }

    .card {
        background: rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        margin-bottom: 25px;
        border: 1px solid rgba(255,255,255,0.08);
    }

    input, textarea {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        margin-top: 8px;
        margin-bottom: 12px;
        font-size: 14px;
    }

    button {
        padding: 12px 20px;
        background: #2563eb;
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
    }
    button:hover { background: #1d4ed8; }

    .list-item {
        background: rgba(255,255,255,0.15);
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
    }

    .delete-btn {
        background: #ef4444;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 12px;
        border: none;
    }

    #toast {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: black;
        color: white;
        padding: 14px 20px;
        border-radius: 8px;
        opacity: 0;
        transition: 0.4s;
    }
</style>

</head>
<body>

<div class="nav">
    <h3>Admin Login Access Control</h3>
    <button id="logoutBtn">Log Out</button>
</div>

<div class="container">

    <div class="card">
        <h2>Add Allowed Emails (Bulk)</h2>
        <textarea id="bulkInput" rows="6" placeholder="email1@gmail.com 2022/ICT/62"></textarea>
        <button id="bulkAddBtn">Add Bulk</button>
    </div>

    <div class="card">
        <h2>Add Single Allowed Email</h2>
        <input type="text" id="singleEmail" placeholder="Email">
        <input type="text" id="singleReg" placeholder="Registration Number">
        <button id="singleAddBtn">Add Email</button>
    </div>

    <div class="card">
        <h2>Banned Registration Numbers</h2>
        <input type="text" id="banReg" placeholder="Registration Number">
        <input type="text" id="banMsg" placeholder="Ban Message">
        <button id="banAddBtn">Add Ban</button>
    </div>

    <div class="card">
        <h2>Allowed Emails List</h2>
        <div id="allowedList"></div>
    </div>

    <div class="card">
        <h2>Banned List</h2>
        <div id="bannedList"></div>
    </div>

</div>

<div id="toast"></div>

<script type="module">
import { getAuth, onAuthStateChanged, signOut }
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  getFirestore, collection, addDoc, deleteDoc,
  doc, getDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

import { app } from "./assets/js/firebase.js";

const auth = getAuth();
const db = getFirestore(app);

// Correct Firestore paths
const allowedRef = collection(db, "login_control", "access", "allowedEmails");
const bannedRef  = collection(db, "login_control", "access", "bannedReg");

// Toast function
function toast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 2000);
}

// AUTH + ADMIN CHECK
onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "index.html";

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) return window.location.href = "index.html";

    const role = (snap.data().role || "").toLowerCase();

    if (!["admin", "owner"].includes(role)) {
        alert("Access denied.");
        window.location.href = "access-denied.html";
    }
});

// BULK ADD
bulkAddBtn.onclick = async () => {
    const lines = bulkInput.value.trim().split("\n");

    for (let line of lines) {
        const [email, regNo] = line.split(/\s+/);

        if (email && regNo) {
            await addDoc(allowedRef, { email, regNo });
        }
    }

    toast("Bulk added!");
};

// SINGLE ADD
singleAddBtn.onclick = async () => {
    const email = singleEmail.value.trim();
    const regNo = singleReg.value.trim();

    if (!email || !regNo) return toast("Fill both fields!");

    await addDoc(allowedRef, { email, regNo });
    toast("Added!");
};

// BAN ADD
banAddBtn.onclick = async () => {
    const regNo = banReg.value.trim();
    const message = banMsg.value.trim();

    if (!regNo || !message) return toast("Fill both fields!");

    await addDoc(bannedRef, { regNo, message });
    toast("Ban added!");
};

// REALTIME LISTS
onSnapshot(allowedRef, (snap) => {
    allowedList.innerHTML = "";
    snap.forEach(docSnap => {
        const d = docSnap.data();
        allowedList.innerHTML += `
            <div class="list-item">
                ${d.email} — ${d.regNo}
                <button class="delete-btn" onclick="deleteAllowed('${docSnap.id}')">Delete</button>
            </div>
        `;
    });
});

onSnapshot(bannedRef, (snap) => {
    bannedList.innerHTML = "";
    snap.forEach(docSnap => {
        const d = docSnap.data();
        bannedList.innerHTML += `
            <div class="list-item">
                ${d.regNo} — ${d.message}
                <button class="delete-btn" onclick="deleteBanned('${docSnap.id}')">Delete</button>
            </div>
        `;
    });
});

// DELETE FUNCTIONS
window.deleteAllowed = async (id) => {
    await deleteDoc(doc(db, "login_control", "access", "allowedEmails", id));
    toast("Deleted");
};

window.deleteBanned = async (id) => {
    await deleteDoc(doc(db, "login_control", "access", "bannedReg", id));
    toast("Deleted");
};

// LOGOUT
logoutBtn.onclick = () => {
    signOut(auth);
    window.location.href = "index.html";
};
</script>

</body>
</html>
